{% set page_title = 'Dataset ' + dataset.name %}
{% extends "layout.html" %}
{% macro dataset_link(label, path=None, ext=None) -%}
  {% if ext %}
  <a href="{{ url_for("show_dataset", name=current_user.name, collection_name=dataset.collection.name, dataset_name=dataset.name, path=path) }}{{ ext }}">{{ label }}</a>
  {% else %}
  <a href="{{ url_for("show_dataset", name=current_user.name, collection_name=dataset.collection.name, dataset_name=dataset.name, path=path) }}">{{ label }}</a>
  {% endif %}
{%- endmacro %}
{% macro dataset_partial(collection, dataset) -%}
  <div class="col-xs-2">
    {% if dataset.has_thumbnail %}
    <img class="img-responsive" width="64" height="64" src="{{ url_for("show_dataset", name=collection.user.name, collection_name=collection.name, dataset_name=dataset.name, path='.thumb.jpg') }}"/>
    {% else %}
    <img class="img-responsive" src="https://placeholdit.imgix.net/~text?txtsize=33&txt=%C3%97&w=64&h=64"/>
    {% endif %}
  </div>
  <div class="col-xs-10">
    <h3 class="dataset-link">
      <a href="{{ url_for("show_dataset", name=collection.user.name, collection_name=collection.name, dataset_name=dataset.name) }}">{{ dataset.name }}</a>
    </h3>
    <p>
    {% if dataset.description %}
      {{ dataset.description }}
    {% endif %}
    </p>
  </div>
{%- endmacro %}
{% macro dataset_row(collection, dataset) -%}
<div class="row dataset-pad">
  {{ dataset_partial(collection, dataset) }}
</div>
{%- endmacro %}

{% block body %}

<div class="row" id="meta-info">
  <div class="col-lg-12">
    <div class="page-header">
      <h2>
    {% raw %}
      <div class="clickable">
        <i v-bind:class="{ 'fa fa-bookmark': bookmarked, 'fa fa-bookmark-o': !bookmarked }"
           v-on:click="bookmark"></i>
      </div>
    {% endraw %}
{% if dataset.type == "samplescan" %}
      Sample scan
{% elif dataset.type == "volume" %}
      Volume
{% else %}
      Information
{% endif %}
â€“ <a href="{{ url_for("show_collection", name=current_user.name, collection_name=collection.name) }}">{{ collection.name }}</a> / {{ dataset.name }}
      </h2>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-3">
    {% if dataset.has_thumbnail %}
    <img class="img-responsive" width="128" height="128" src="{{ url_for("show_dataset", name=collection.user.name, collection_name=collection.name, dataset_name=dataset.name, path='.thumb.jpg') }}"/>
    {% else %}
    <img class="img-responsive" src="https://placeholdit.imgix.net/~text?txtsize=33&txt=%C3%97&w=128&h=128"/>
    {% endif %}
  </div>
  <div class="col-md-3">
    {% if dataset.type == "samplescan" %}
    <p>Genus: <a href="{{ url_for("filter", genus=dataset.genus.id) }}">{{ dataset.genus.name}}</a></p>
  </div>
  <div class="col-md-3">
    <p>Family: <a href="{{ url_for("filter", family=dataset.family.id) }}">{{ dataset.family.name}}</a></p>
  </div>
  <div class="col-md-3">
    <p>Order: <a href="{{ url_for("filter", order=dataset.order.id) }}">{{ dataset.order.name}}</a></p>
    {% endif %}
  </div>
</div>
{% if parents %}
<div class="row">
  <div class="col-lg-12">
    <h3>Parent dataset</h3>
  </div>
</div>
{{ dataset_row(collection, parents[0]) }}
{% endif %}
{% if children %}
<div class="row">
  <div class="col-lg-12">
    <h3>Derived datasets</h3>
  </div>
</div>
{% for group in children|group(3) %}
<div class="row dataset-pad">
  {% for dataset in group %}
  <div class="col-lg-4">
    <div class="row">
      {{ dataset_partial(collection, dataset) }}
    </div>
  </div>
  {% endfor %}
</div>
{% endfor %}
{% endif %}
{% if dataset.type == "samplescan" %}
<div class="row">
  <div class="col-lg-12">
    <div class="page-header">
      <h2>Reconstruct</h2>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <form class="form-inline" method="POST" action="{{ url_for("process", dataset_id=dataset.id) }}">
      <div class="form-group">
        <input class="form-control" name="name" placeholder="Dataset">
      </div>
      <div class="form-group">
        <input class="form-control" name="darks" placeholder="Darks">
      </div>
      <div class="form-group">
        <input class="form-control" name="flats" placeholder="Flats">
      </div>
      <div class="form-group">
        <input class="form-control" name="projections" placeholder="Projections">
      </div>
      <div class="form-group">
        <input class="form-control" name="outname" placeholder="Output">
      </div>
      <button type="submit" class="btn btn-default">Reconstruct</button>
    </form>
  </div>
</div>
{% endif %}
{% if list_files %}
<div class="row">
  <div class="col-lg-12">
    <h2>Files</h2>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <table class="table">
      <thead>
        <tr>
          <td width="20px"></td>
          <td></td>
          <td></td>
        </tr>
      </thead>
      <tbody>
        {% for dirname in dirs %}
        <tr>
          <td><i class="fa fa-folder-o" aria-hidden="true"></i></td>
          <td>{{ dataset_link(dirname, path, dirname) }}</td>
          <td></td>
        </tr>
        {% endfor %}
        {% for filename, filesize in files %}
        <tr>
          <td><i class="fa fa-file-o" aria-hidden="true"></i></td>
          <td>{{ dataset_link(filename, path, filename) }}</td>
          <td>{{ filesize | filesizeformat }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
<div class= "row" id="reviews">
  {% raw %}
  <div class="col-lg-12">
    <div class="page-header">
      <h2>Reviews</h2>
      <div>
        <i v-for="n in base_rating" class="fa fa-star fa-2x"></i>
        <i v-if="half_star" class="fa fa-star-half-o fa-2x"></i>
        <span v-if="!half_star"><i v-for="n in 5-base_rating" class="fa fa-star-o fa-2x"></i></span>
        <span v-if="half_star"><i v-for="n in 4-base_rating" class="fa fa-star-o fa-2x"></i></span>
      </div>
    </div>
  </div>
  <div class="col-lg-12" >
      <div class="review-item col-lg-12" v-for="review in reviews">
        <div class="ri-time col-lg-1"><p>{{ timeSince(review.created_at) }}</p></div>
        <div class="col-lg-11">
          <p>
            <a class="ri-sender" v-bind:href="review.sender_url">{{ review.sender_name }}</a>
            <i v-if="! review_being_updated || ! review.editable" v-for="n in review.rating" class="fa fa-star"></i>
          </p>
          <div id="review-update-input" v-if="review_being_updated && review.editable">
            <textarea v-model="review_text" id="review-update-input-textarea" v-on:keyup.enter="sendUpdatedReview"></textarea>
            <p id="rating-stars"  v-bind:class="{ rated: is_rated }">
              <i v-for="i in n" v-on:click="rate(i)" class="fa fa-star"></i><i v-for="i in 5-n" v-on:click="rate(n+i)" class="fa fa-star-o"></i>
            </p>
          </div>
          <div v-else><p>{{ review.comment }}</p></div>
          <div v-if="review.editable" class="ri-options">
            <a v-if="! review_being_updated" v-on:click="beginUpdatingReview(review)" class="clickable">
              <i class="fa fa-pencil"></i> Edit
            </a>
            <a v-if="review_being_updated" v-on:click="endUpdatingReview" class="clickable">
              <i class="fa fa-times"></i> Cancel
            </a>
            <a v-if="review_being_updated" v-on:click="sendUpdatedReview" class="clickable">
              <i class="fa fa-arrow-right"></i> Update
            </a>
            <a v-if="! review_being_updated" v-on:click="beginDeletingReview(review)" class="clickable">
              <i class="fa fa-trash"></i> Delete
            </a>
          </div>
          <hr/>
        </div>
      </div>
  </div>
  {% endraw %}
  <div class="row">
    <div class="col-lg-12">
      <div v-if="review_count > 3" class="col-lg-offset-11 col-lg-1"><a class="cursor-pointer">See More</a></div>
      <div v-if="show_review_input" class="col-lg-12" id="review-input">
        <div>
          <textarea v-model="review_text" placeholder="Write a review ..." v-on:keydown.enter.prevent="sendNewReview"></textarea>
          <p class="alert" v-show="rating_notified">Not rated yet</p>
          <p id="rating-stars"  v-bind:class="{ rated: is_rated }">
            <i v-for="i in n" v-on:click="rate(i)" class="fa fa-star"></i><i v-for="i in 5-n" v-on:click="rate(n+i)" class="fa fa-star-o"></i>
          </p>
        </div>
        <div>
          <button type="submit" v-on:click="sendNewReview" class="btn btn-default">Send</button>
        </div>
      </div>
    </div>
  </div>
  <confirmdeletion :show.sync="show_modal_delete_review">
    <h1 slot="modal-title">Confirm Deletion</h1>
    <p slot="modal-body">Are you sure you want to delete this review?</p>
    <div slot="modal-options">
      <div class="modal-button modal-button-delete">
        <button class="modal-delete-button" @click="deleteReview()"><i class="fa fa-trash"></i> Delete</button>
      </div>
      <div class="modal-button">
        <button class="modal-cancel-button" @click="dismissModal()"><i class="fa fa-times"></i> Cancel</button>
      </div>
    </div>
  </confirmdeletion>
</div>
<script>var dataset_id = {{ dataset.id }};</script>
<script>System.import('dataset.js')</script>
{% endblock %}
