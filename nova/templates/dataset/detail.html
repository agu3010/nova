{% set page_title = 'Dataset ' + dataset.name %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dataset.css') }}" />
{% endblock %}
{% extends "layout.html" %}
{% macro dataset_link(label, path=None, ext=None) -%}
  {% if ext %}
  <a href="{{ url_for("show_dataset", name=current_user.name, collection_name=dataset.collection.name, dataset_name=dataset.name, path=path) }}{{ ext }}">{{ label }}</a>
  {% else %}
  <a href="{{ url_for("show_dataset", name=current_user.name, collection_name=dataset.collection.name, dataset_name=dataset.name, path=path) }}">{{ label }}</a>
  {% endif %}
{%- endmacro %}
{% macro dataset_partial(collection, dataset) -%}
  <div class="col-xs-2">
    {% if dataset.has_thumbnail %}
    <img class="img-responsive" width="64" height="64" src="{{ url_for("show_dataset", name=collection.user.name, collection_name=collection.name, dataset_name=dataset.name, path='.thumb.jpg') }}"/>
    {% else %}
    <img class="img-responsive" src="https://placeholdit.imgix.net/~text?txtsize=33&txt=%C3%97&w=64&h=64"/>
    {% endif %}
  </div>
  <div class="col-xs-10">
    <h3 class="dataset-link">
      <a href="{{ url_for("show_dataset", name=collection.user.name, collection_name=collection.name, dataset_name=dataset.name) }}">{{ dataset.name }}</a>
    </h3>
    <p>
    {% if dataset.description %}
      {{ dataset.description }}
    {% endif %}
    </p>
  </div>
{%- endmacro %}
{% macro dataset_row(collection, dataset) -%}
<div class="row dataset-pad">
  {{ dataset_partial(collection, dataset) }}
</div>
{%- endmacro %}

{% block body %}

<div class="row" id="meta-info">
  <div class="col-lg-12">
    <div class="page-header">
      <h2>
    {% raw %}
    <div><span v-if="bookmarked"><i v-on:click="bookmark" class="fa fa-bookmark"></i></span><span v-else><i v-on:click="bookmark" class="fa fa-bookmark-o"></i></span></div>
    {% endraw %}
{% if dataset.type == "samplescan" %}
      Sample scan
{% elif dataset.type == "volume" %}
      Volume
{% else %}
      Information
{% endif %}
â€“ <a href="{{ url_for("show_collection", name=current_user.name, collection_name=collection.name) }}">{{ collection.name }}</a> / {{ dataset.name }}
      </h2>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-md-3">
    {% if dataset.has_thumbnail %}
    <img class="img-responsive" width="128" height="128" src="{{ url_for("show_dataset", name=collection.user.name, collection_name=collection.name, dataset_name=dataset.name, path='.thumb.jpg') }}"/>
    {% else %}
    <img class="img-responsive" src="https://placeholdit.imgix.net/~text?txtsize=33&txt=%C3%97&w=128&h=128"/>
    {% endif %}
  </div>
  <div class="col-md-3">
    {% if dataset.type == "samplescan" %}
    <p>Genus: <a href="{{ url_for("filter", genus=dataset.genus.id) }}">{{ dataset.genus.name}}</a></p>
  </div>
  <div class="col-md-3">
    <p>Family: <a href="{{ url_for("filter", family=dataset.family.id) }}">{{ dataset.family.name}}</a></p>
  </div>
  <div class="col-md-3">
    <p>Order: <a href="{{ url_for("filter", order=dataset.order.id) }}">{{ dataset.order.name}}</a></p>
    {% endif %}
  </div>
</div>
{% if parents %}
<div class="row">
  <div class="col-lg-12">
    <h3>Parent dataset</h3>
  </div>
</div>
{{ dataset_row(collection, parents[0]) }}
{% endif %}
{% if children %}
<div class="row">
  <div class="col-lg-12">
    <h3>Derived datasets</h3>
  </div>
</div>
{% for group in children|group(3) %}
<div class="row dataset-pad">
  {% for dataset in group %}
  <div class="col-lg-4">
    <div class="row">
      {{ dataset_partial(collection, dataset) }}
    </div>
  </div>
  {% endfor %}
</div>
{% endfor %}
{% endif %}
{% if dataset.type == "samplescan" %}
<div class="row">
  <div class="col-lg-12">
    <div class="page-header">
      <h2>Reconstruct</h2>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <form class="form-inline" method="POST" action="{{ url_for("process", dataset_id=dataset.id) }}">
      <div class="form-group">
        <input class="form-control" name="name" placeholder="Dataset">
      </div>
      <div class="form-group">
        <input class="form-control" name="darks" placeholder="Darks">
      </div>
      <div class="form-group">
        <input class="form-control" name="flats" placeholder="Flats">
      </div>
      <div class="form-group">
        <input class="form-control" name="projections" placeholder="Projections">
      </div>
      <div class="form-group">
        <input class="form-control" name="outname" placeholder="Output">
      </div>
      <button type="submit" class="btn btn-default">Reconstruct</button>
    </form>
  </div>
</div>
{% endif %}
{% if list_files %}
<div class="row">
  <div class="col-lg-12">
    <h2>Files</h2>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <table class="table">
      <thead>
        <tr>
          <td width="20px"></td>
          <td></td>
          <td></td>
        </tr>
      </thead>
      <tbody>
        {% for dirname in dirs %}
        <tr>
          <td><i class="fa fa-folder-o" aria-hidden="true"></i></td>
          <td>{{ dataset_link(dirname, path, dirname) }}</td>
          <td></td>
        </tr>
        {% endfor %}
        {% for filename, filesize in files %}
        <tr>
          <td><i class="fa fa-file-o" aria-hidden="true"></i></td>
          <td>{{ dataset_link(filename, path, filename) }}</td>
          <td>{{ filesize | filesizeformat }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
<div class= "row" id="reviews">
  {% raw %}
  <div class="row">
    <div class="col-lg-12">
      <div class="page-header">
        <h2>Reviews</h2>
        <div>
          <i v-for="n in base_rating" class="fa fa-star fa-2x"></i>
          <i v-if="half_star"class="fa fa-star-half-o fa-2x"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="row" >
      <div class="review-item col-lg-12" v-for="review in reviews">
        <div class="ri-time col-lg-1"><p>{{ timeSince(review.created_at) }}</p></div>
        <div class="col-lg-11">
          <p>
            <a v-bind:href="review.sender_url">{{ review.sender_name }}</a> &nbsp;
            <i  v-for="n in review.rating " class="fa fa-star"></i>
          </p>
          <p>{{ review.comment }}</p>
          <hr/>
        </div>
      </div>
  </div>
  {% endraw %}
  <div class="row">
    <div class="col-lg-offset-1 col-lg-1"><a>See More</a></div>
    <div class="col-lg-2"><a>Review Now</a></div>
  </div>
</div>


<script src="https://unpkg.com/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/vue.resource/1.0.3/vue-resource.min.js"></script>
<script>
var meta = new Vue({
  el: '#meta-info',
  data: {
    bookmarked: false,
  },
  created: function() {
      params = {
        token: '{{ current_user.token }}'
      }
      apiStr = '/api/user/'+{{current_user.id}}+'/bookmarks/'+ {{dataset.id}}
      this.$http.get(apiStr, {params: params}).then((response) => {
        if (response.body.exists) this.bookmarked = true;
      });
    },
  methods: {
    bookmark: function (event) {
      params = {
        token: '{{ current_user.token }}'
      }
      apiStr = '/api/user/'+{{current_user.id}}+'/bookmarks/'+ {{dataset.id}}
      if (this.bookmarked) {
        this.$http.delete(apiStr, {params: params}).then((response) => {
          if (response.status == 200) this.bookmarked = false;
        });
      } else {
        this.$http.post(apiStr, null, {params: params}).then((response) => {
          if (response.status == 200) this.bookmarked = true;
        });
      }
    }
  }
})

var reviews = new Vue({
  el: '#reviews',
  data: {
    avg_rating: 0,
    base_rating: 0,
    half_star: false,
    reviews: [],
    count:0
  },
  created: function() {
    params = {
      token: '{{ current_user.token }}'
    }
    apiStr = '/api/datasets/'+{{dataset.id}}+'/reviews'
    this.$http.get(apiStr, {params: params}).then((response) => {
      console.log(response);
      this.count = response.body.count;
      this.avg_rating = response.body.avg_rating;
      this.base_rating = Math.floor(this.avg_rating);
      if (this.avg_rating - this.base_rating >= .5) this.half_star = true;
      if (response.body.count > 0) this.reviews = response.body.data;
    });
  },
  methods: {
    timeSince: function(date) {
      date = new Date(date);
      current = new Date();
      delta = current.getTimezoneOffset(); //delta = 0;
      seconds = Math.floor((new Date() - date) / 1000) + delta*60;
      console.log (new Date()+ " " + date);
      console.log (seconds);

      interval = Math.floor(seconds / 86400);
      if (interval >= 1) {
        return date.toLocaleString();
      }
      interval = Math.floor(seconds / 3600);
      if (interval >= 1) {
        return interval + " h ago";
      }
      interval = Math.floor(seconds / 60);
      if (interval >= 1) {
        return interval + " m ago";
      }
      return Math.floor(seconds) + " s ago";
    }
  }
})

</script>

{% endblock %}
