{% extends "dataset/header.html" %}
{% block dataset_content %}
  <div class="col-md-12">
    <div id="wave-container">
      <img id="loading-wave" src={{ url_for('static', filename='img/spinner.gif')}} />
    </div>
    <div id="wave-controls" class="col-md-12">
      <h3>Controls</h3>
      <div class="wave-control">
        <p>Gray Value Threshold</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="gray-threshold-min-input" /></div>
          <div class="col-sm-8" id="slider-gray-threshold"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="gray-threshold-max-input" /></div>
        </div>
      </div>
      <div class="wave-control">
        <p>X axis slicing</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="x-min-input" /></div>
          <div class="col-sm-8" id="slider-X"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="x-max-input" /></div>
        </div>
      </div>
      <div class="wave-control">
        <p>Y axis slicing</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="y-min-input" /></div>
          <div class="col-sm-8" id="slider-Y"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="y-max-input" /></div>
        </div>
      </div>
      <div class="wave-control">
        <p>Z axis slicing</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="z-min-input" /></div>
          <div class="col-sm-8" id="slider-Z"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="z-max-input" /></div>
        </div>
      </div>
      <div class="wave-control">
        <button type="button" class="btn btn-dark" id="res-zoom-button">Zoom to Sliced Volume</button>
      </div>
    </div>
  </div>
  <script
  src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/wave/three.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/TrackballControls.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/ejs.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/volumeRaycaster.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/stats.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dragslider.js') }}"></script>
  <script>
        var current_x = 0, current_y = 0, current_z = 0, current_dim = 100;
        var collection_name = '{{ collection }}';
        var dataset_name = '{{ dataset.name }}';
        var user_name = '{{ owner.name }}';
        var is_wave = true;
        var ops = {{ ops|tojson|safe if ops!=None else 'null' }};
        function beginWave(slicemaps) {
            config = {
                "dom_container": "wave-container",
                "slicemaps_paths": slicemaps,
                "steps" : 144,
                "shader_name": "secondPassSoebel",
                "slices_range": [0, 255],
                "row_col": [16, 16],
                "renderer_size": [512, 512],
                "renderer_canvas_size": ['*','*'],
            };

            rcl2 = new VRC.VolumeRaycaster(config);
            gt = ops["gray-thresholds"];
            if (gt != null) {
                rcl2.setGrayMinValue(gt[0]/255);
                rcl2.setGrayMaxValue(gt[1]/255);
            }
        }
        function sendContinuousGetToLocationUntilDone(loc) {
            $.ajax(loc, {
                method:"GET",
                crossDomain:true
            }).done(function(data, textStatus, jqXHR) {
                if (data.status == 'running') {
                    setTimeout(function() {
                        sendContinuousGetToLocationUntilDone(loc);
                    }, 2000);
                } else {
                    $location = jqXHR.getResponseHeader('location');
                    slicemaps = [$location];
                    $( "#loading-wave" ).remove();
                    beginWave(slicemaps);
                }
            });
        }
        $( document ).ready(function() {
            $minGT = 0, $maxGT = 255;
            $("#wave-container").height($("#wave-container").width());
            $params = {
                "token": "{{token|safe}}",
                "user": user_name,
                "dataset": dataset_name,
                "subset": 2
            };
            if (ops != null) {
                current_x = ops["origin"][0];
                current_y = ops["origin"][1];
                current_z =ops["origin"][2];
                current_dim = ops["dimensions"][0];
                $params["origin"] = [current_x/100, current_y/100, current_z/100];
                $params["dimensions"] = [current_dim/100, current_dim/100];
                $gt = ops["gray-thresholds"];
                if ($gt != null) {
                    $minGT = $gt[0];
                    $maxGT = $gt[1];
                }
            }
            $params = JSON.stringify($params);
            $.ajax("http://localhost:5001/maps", {
                data:$params,
                contentType:"application/json",
                method:"POST"
            }).done(function(data, textStatus, jqXHR){
                $location = jqXHR.getResponseHeader('location');
                sendContinuousGetToLocationUntilDone($location)
            }).fail(function() { alert( "An error occured" ); });
            $("#slider-gray-threshold").slider ({
                range: true,
                min: 0,
                max: 255,
                values: [$minGT, $maxGT],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    rcl2.setGrayMinValue($min/255);
                    $("#gray-threshold-min-input").val($min);
                    rcl2.setGrayMaxValue($max/255);
                    $("#gray-threshold-max-input").val($max);
                }
            });
            $("#slider-X").dragslider ({
                range: true,
                rangeDrag: true,
                min: 0,
                max: 100,
                values: [0, 100],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    rcl2.setGeometryMinX($min/100);
                    $("#x-min-input").val($min);
                    rcl2.setGeometryMaxX($max/100);
                    $("#x-max-input").val($max);
                }
            });
            $("#slider-Y").dragslider ({
                range: true,
                rangeDrag: true,
                min: 0,
                max: 100,
                values: [0, 100],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    rcl2.setGeometryMinY($min/100);
                    $("#y-min-input").val($min);
                    rcl2.setGeometryMaxY($max/100);
                    $("#y-max-input").val($max);
                }
            });
            $("#slider-Z").dragslider ({
                range: true,
                rangeDrag: true,
                min: 0,
                max: 100,
                values: [0, 100],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    rcl2.setGeometryMinZ($min/100);
                    $("#z-min-input").val($min);
                    rcl2.setGeometryMaxZ($max/100);
                    $("#z-max-input").val($max);
                }
            });
            $("#gray-threshold-min-input").val($minGT);
            $("#gray-threshold-max-input").val($maxGT);
            $("#x-min-input").val(0);
            $("#x-max-input").val(100);
            $("#y-min-input").val(0);
            $("#y-max-input").val(100);
            $("#z-min-input").val(0);
            $("#z-max-input").val(100);
            $("#gray-threshold-min-input").change(function() {
                $max = $("#slider-gray-threshold" ).slider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-gray-threshold").slider("option", "values", $values);
                rcl2.setGrayMinValue($(this).val()/255);
            });
            $("#gray-threshold-max-input").change(function() {
                $min = $("#slider-gray-threshold" ).slider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-gray-threshold").slider("option", "values", $values);
                rcl2.setGrayMaxValue($(this).val()/255);
            });
            $("#x-min-input").change(function() {
                $max = $("#slider-X" ).dragslider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-X").dragslider("option", "values", $values);
                rcl2.setGeometryMinX($(this).val()/100);
            });
            $("#x-max-input").change(function() {
                $min = $("#slider-X" ).dragslider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-X").dragslider("option", "values", $values);
                rcl2.setGeometryMaxX($(this).val()/100);
            });
            $("#y-min-input").change(function() {
                $max = $("#slider-Y" ).dragslider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-Y").dragslider("option", "values", $values);
                rcl2.setGeometryMinY($(this).val()/100);
            });
            $("#y-max-input").change(function() {
                $min = $("#slider-Y" ).dragslider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-Y").dragslider("option", "values", $values);
                rcl2.setGeometryMaxY($(this).val()/100);
            });
            $("#z-min-input").change(function() {
                $max = $("#slider-Z" ).dragslider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-Z").dragslider("option", "values", $values);
                rcl2.setGeometryMinZ($(this).val()/100);
            });
            $("#z-max-input").change(function() {
                $min = $("#slider-Z" ).dragslider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-Z").dragslider("option", "values", $values);
                rcl2.setGeometryMaxZ($(this).val()/100);
            });
            $("#res-zoom-button").click( function() {
                $x = $("#x-min-input").val();
                $y = $("#y-min-input").val();
                $z = $("#z-min-input").val();
                $X = $("#x-max-input").val();
                $Y = $("#y-max-input").val();
                $Z = $("#z-max-input").val();
                $size = Math.min(Math.abs($X-$x), Math.abs($Y-$y), Math.abs($Z-$z));
                $adj_size = Math.round($size*current_dim/100);
                $adj_x = Math.round(current_x + $x*current_dim/100);
                $adj_y = Math.round(current_y + $y*current_dim/100);
                $adj_z = Math.round(current_z + $z*current_dim/100);
                $vol = [$adj_x, $adj_y, $adj_z, $adj_size];
                $gray = [$("#gray-threshold-min-input").val(), $("#gray-threshold-max-input").val()];
                window.location.href='/wave?user='+user_name+'&dataset='+dataset_name+'&collection='+collection_name+'&vol='+$vol+'&gt='+$gray;
            });
         });
  </script>
  <script>System.import('dataset.js')</script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
{% endblock %}
