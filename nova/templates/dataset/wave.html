{% extends "dataset/header.html" %}
{% block dataset_content %}
  <div class="col-md-12">
    <div id="wave-container">
      <img id="loading-wave" src={{ url_for('static', filename='img/spinner.gif')}} />
    </div>
    <div id="wave-controls" class="col-md-12">
      <h3>Controls</h3>
      <div class="wave-control">
        <p>Gray Value Threshold</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="gray-threshold-min-input" /></div>
          <div class="col-sm-8" id="slider-gray-threshold"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="gray-threshold-max-input" /></div>
        </div>
      </div>
      <div class="wave-control" id="zoom-controls">
        <p>Zoom Control</p>
        <div>
          <div id="xy-zoom-control"><div id="xy-zoom-selection"></div></div>
          <p><small>x-y plane</small></p>
        </div>
        <div>
          <div id="yz-zoom-control"><div id="yz-zoom-selection"></div></div>
          <p><small>y-z plane</small></p>
        </div>
      </div>
      <div class="wave-control">
        <button type="button" class="btn btn-dark" id="res-zoom-button-selection">Zoom to Selected Volume</button>
      </div>
      <div class="wave-control">
        <p>X axis slicing</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="x-min-input" /></div>
          <div class="col-sm-8" id="slider-X"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="x-max-input" /></div>
        </div>
      </div>
      <div class="wave-control">
        <p>Y axis slicing</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="y-min-input" /></div>
          <div class="col-sm-8" id="slider-Y"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="y-max-input" /></div>
        </div>
      </div>
      <div class="wave-control">
        <p>Z axis slicing</p>
        <div class="col-sm-12">
          <div class="col-sm-2"><input type="text" class="slider-range-input pull-right" id="z-min-input" /></div>
          <div class="col-sm-8" id="slider-Z"></div>
          <div class="col-sm-2"><input type="text" class="slider-range-input" id="z-max-input" /></div>
        </div>
      </div>
      <div class="wave-control">
        <button type="button" class="btn btn-dark" id="res-zoom-button-slice">Zoom to Sliced Volume</button>
      </div>
    </div>
  </div>
  <script
  src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
  integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
  crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/wave/three.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/TrackballControls.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/ejs.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/volumeRaycaster.js') }}"></script>
  <script src="{{ url_for('static', filename='js/wave/stats.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dragslider.js') }}"></script>
  <script>
        $slicemaps = {};
        var collection_name = '{{ collection }}';
        var dataset_name = '{{ dataset.name }}';
        var user_name = '{{ owner.name }}';
        var is_wave = true;

        $minGT = 0, $maxGT = 255;
        $current_x = 0, $current_y = 0, $current_z = 0, $current_dim = 100;
        $subsets = 5;
        $ops = {{ ops|tojson|safe if ops!=None else 'null' }};

        if ($ops != null) {
            $current_x = $ops["origin"][0];
            $current_y = $ops["origin"][1];
            $current_z = $ops["origin"][2];
            $current_dim = $ops["dimensions"][0];
            $gt = $ops["gray-thresholds"];
            if ($gt != null) {
                $minGT = $gt[0];
                $maxGT = $gt[1];
            }
        }

        function beginWave($a) {
            $config = {
                "dom_container": "wave-container",
                "slicemaps_paths": $a,
                "steps" : 144,
                "shader_name": "secondPassSoebel",
                "slices_range": [0, $subsets * 256 - 1],
                "row_col": [16, 16],
                "renderer_size": [512, 512],
                "renderer_canvas_size": ['*','*']
            };

            $vrc = new VRC.VolumeRaycaster($config);
            $vrc.setGrayMinValue($minGT/255);
            $vrc.setGrayMaxValue($maxGT/255);
        }

        function sendContinuousGetToLocationUntilDone($loc) {
            $.ajax($loc, {
                method:"GET",
                crossDomain:true
            }).done(function(data, textStatus, jqXHR) {
                if (data.status == 'running') {
                    setTimeout(function() {
                        sendContinuousGetToLocationUntilDone($loc);
                    }, 2000);
                } else {
                    $location = jqXHR.getResponseHeader('location');
                    $slicemaps[data.subset] = $location;

                    if (Object.keys($slicemaps).length == $subsets) {
                        $( "#loading-wave" ).remove();
                        $a = [];

                        for ($i = 0; $i < $subsets; $i++)
                            $a.push($slicemaps[$i]);

                        beginWave($a);
                    }
                }
            });
        }
        $( document ).ready(function() {
            $("#wave-container").height($("#wave-container").width());
            $origin_array = [$current_x/100, $current_y/100, $current_z/100];
            $dimensions_array = [$current_dim/100, $current_dim/100];
            for ($i = 0; $i < $subsets; $i++) {
                $params = JSON.stringify({
                    "token": "{{token|safe}}",
                    "user": user_name,
                    "dataset": dataset_name,
                    "subset": $i,
                    "origin": $origin_array,
                    "dimensions": $dimensions_array
                });
                $.ajax("http://localhost:5001/maps", {
                    data:$params,
                    contentType:"application/json",
                    method:"POST"
                }).done(function(data, textStatus, jqXHR){
                    $location = jqXHR.getResponseHeader('location');
                    sendContinuousGetToLocationUntilDone($location);
                }).fail(function() { alert( "An error occured" ); });
            }

            $("#slider-gray-threshold").slider ({
                range: true,
                min: 0,
                max: 255,
                values: [$minGT, $maxGT],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    $vrc.setGrayMinValue($min/255);
                    $("#gray-threshold-min-input").val($min);
                    $vrc.setGrayMaxValue($max/255);
                    $("#gray-threshold-max-input").val($max);
                }
            });
            $("#slider-X").dragslider ({
                range: true,
                rangeDrag: true,
                min: 0,
                max: 100,
                values: [0, 100],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    $vrc.setGeometryMinX($min/100);
                    $("#x-min-input").val($min);
                    $vrc.setGeometryMaxX($max/100);
                    $("#x-max-input").val($max);
                }
            });
            $("#slider-Y").dragslider ({
                range: true,
                rangeDrag: true,
                min: 0,
                max: 100,
                values: [0, 100],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    $vrc.setGeometryMinY($min/100);
                    $("#y-min-input").val($min);
                    $vrc.setGeometryMaxY($max/100);
                    $("#y-max-input").val($max);
                }
            });
            $("#slider-Z").dragslider ({
                range: true,
                rangeDrag: true,
                min: 0,
                max: 100,
                values: [0, 100],
                slide: function( event, ui ) {
                    $min = ui.values[0];
                    $max = ui.values[1];
                    $vrc.setGeometryMinZ($min/100);
                    $("#z-min-input").val($min);
                    $vrc.setGeometryMaxZ($max/100);
                    $("#z-max-input").val($max);
                }
            });
            $("#gray-threshold-min-input").val($minGT);
            $("#gray-threshold-max-input").val($maxGT);
            $("#x-min-input").val(0);
            $("#x-max-input").val(100);
            $("#y-min-input").val(0);
            $("#y-max-input").val(100);
            $("#z-min-input").val(0);
            $("#z-max-input").val(100);
            $("#gray-threshold-min-input").change(function() {
                $max = $("#slider-gray-threshold" ).slider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-gray-threshold").slider("option", "values", $values);
                $vrc.setGrayMinValue($(this).val()/255);
            });
            $("#gray-threshold-max-input").change(function() {
                $min = $("#slider-gray-threshold" ).slider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-gray-threshold").slider("option", "values", $values);
                $vrc.setGrayMaxValue($(this).val()/255);
            });
            $("#x-min-input").change(function() {
                $max = $("#slider-X" ).dragslider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-X").dragslider("option", "values", $values);
                $vrc.setGeometryMinX($(this).val()/100);
            });
            $("#x-max-input").change(function() {
                $min = $("#slider-X" ).dragslider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-X").dragslider("option", "values", $values);
                $vrc.setGeometryMaxX($(this).val()/100);
            });
            $("#y-min-input").change(function() {
                $max = $("#slider-Y" ).dragslider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-Y").dragslider("option", "values", $values);
                $vrc.setGeometryMinY($(this).val()/100);
            });
            $("#y-max-input").change(function() {
                $min = $("#slider-Y" ).dragslider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-Y").dragslider("option", "values", $values);
                $vrc.setGeometryMaxY($(this).val()/100);
            });
            $("#z-min-input").change(function() {
                $max = $("#slider-Z" ).dragslider("option", "values")[1];
                $(this).val($(this).val() < $max ?$(this).val():$max);
                $values = [$(this).val(), $max];
                $("#slider-Z").dragslider("option", "values", $values);
                $vrc.setGeometryMinZ($(this).val()/100);
            });
            $("#z-max-input").change(function() {
                $min = $("#slider-Z" ).dragslider("option", "values")[0];
                $(this).val($(this).val() > $min ?$(this).val():$min);
                $values = [$min, $(this).val()];
                $("#slider-Z").dragslider("option", "values", $values);
                $vrc.setGeometryMaxZ($(this).val()/100);
            });
            function zoomToVolume($v) {
                $gray = [$("#gray-threshold-min-input").val(), $("#gray-threshold-max-input").val()];
                window.location.href='/wave?user='+user_name+'&dataset='+dataset_name+'&collection='+collection_name+'&vol='+$v+'&gt='+$gray;
            }
            $("#res-zoom-button-slice").click( function() {
                $x = $("#x-min-input").val();
                $y = $("#y-min-input").val();
                $z = $("#z-min-input").val();
                $X = $("#x-max-input").val();
                $Y = $("#y-max-input").val();
                $Z = $("#z-max-input").val();
                $size = Math.min(Math.abs($X-$x), Math.abs($Y-$y), Math.abs($Z-$z));
                $adj_size = Math.round($size*$current_dim/100);
                $adj_x = Math.round($current_x + $x*$current_dim/100);
                $adj_y = Math.round($current_y + $y*$current_dim/100);
                $adj_z = Math.round($current_z + $z*$current_dim/100);
                $vol = [$adj_x, $adj_y, $adj_z, $adj_size];
                zoomToVolume($vol);
            });
            $("#res-zoom-button-selection").click( function() {
                $W = $("#xy-zoom-selection").parent().width();
                $x = Math.round(100*parseInt($("#xy-zoom-selection").css("left"), 10)/$W);
                $y = Math.round(100*parseInt($("#xy-zoom-selection").css("top"), 10)/$W);
                $z = Math.round(100*parseInt($("#yz-zoom-selection").css("top"), 10)/$W);
                $size = Math.round(100*$("#yz-zoom-selection").width()/$W);
                $vol = [$x, $y, $z, $size];
                zoomToVolume($vol);
            });
            $("#xy-zoom-selection").resizable({
                aspectRatio: 1,
                containment: "parent",
                create: function (event, ui ){
                    $(this).css({
                        'left': $current_x*$(this).parent().width()/100,
                        'top': $current_y*$(this).parent().height()/100,
                        'width': $current_dim*$(this).parent().width()/100,
                        'height': $current_dim*$(this).parent().height()/100
                    });
                },
                resize: function (event, ui ){
                    h = ui.size.height;
                    t = ui.position.top;
                    $("#yz-zoom-selection").css({'height':h, 'width': h,'left': t});
                }
            }).draggable({
                containment: "parent",
                drag: function (event, ui) {
                    t = ui.position.top;
                    $("#yz-zoom-selection").css({'left': t});
                }
            });
            $("#yz-zoom-selection").resizable({
                aspectRatio: 1,
                containment: "parent",
                create: function (event, ui ){
                    $(this).css({
                        'left': $current_y*$(this).parent().width()/100,
                        'top': $current_z*$(this).parent().height()/100,
                        'width': $current_dim*$(this).parent().width()/100,
                        'height': $current_dim*$(this).parent().height()/100
                    });
                },
                resize: function (event, ui ){
                    w = ui.size.width;
                    l = ui.position.left;
                    $("#xy-zoom-selection").css({'height':w, 'width': w,'top':l});
                }
            }).draggable({
                containment: "parent",
                drag: function (event, ui) {
                    l = ui.position.left;
                    $("#xy-zoom-selection").css({'top': l});
                }
            });
         });
  </script>
  <script>System.import('dataset.js')</script>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
{% endblock %}
